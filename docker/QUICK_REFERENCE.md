# Docker Runners - Quick Reference

## First Time Setup

```bash
# 1. Generate tokens and create .env
bash docker/setup-runners.sh

# 2. Build containers
docker compose build

# 3. Start containers
docker compose up -d

# 4. Verify
docker compose ps
```

## Common Commands

```bash
# View all runner status
docker compose ps

# View live logs from all runners
docker compose logs -f

# View logs from specific runner
docker compose logs -f tenfive-runner

# Stop all runners (keeps volumes)
docker compose stop

# Stop all and remove containers (keeps volumes)
docker compose down

# Full cleanup (removes everything)
docker compose down -v

# Restart runners
docker compose restart

# Execute command in container
docker compose exec tenfive-runner bash
```

## Regenerate Tokens (expires after 1 hour)

```bash
# Generate new tokens and update .env
bash docker/setup-runners.sh

# Restart containers with new tokens
docker compose restart
```

## Check GitHub Registration

```bash
# List all runners
gh api repos/trodemaster/blakeports/actions/runners

# Check status
gh api repos/trodemaster/blakeports/actions/runners --jq '.runners[] | {name, status, busy}'

# Check specific runner labels
gh api repos/trodemaster/blakeports/actions/runners --jq '.runners[] | select(.name=="tenfive-runner") | .labels'
```

## Troubleshooting

### Runners show as "offline" but not connecting

```bash
# Check container logs
docker compose logs tenfive-runner | grep -i error
docker compose logs tenfive-runner | grep "SSH connection"

# Test SSH manually from container
docker compose exec tenfive-runner bash
ssh -F ~/.ssh/config tenfive "echo test"
```

### SSH key permissions wrong

```bash
# Fix permissions
chmod 600 docker/ssh_keys/oldmac

# Verify
ls -la docker/ssh_keys/oldmac
# Should show: -rw------- (600 permissions)
```

### Registration token expired

```bash
# Regenerate
bash docker/setup-runners.sh

# Restart
docker compose restart
```

## Using Runners in Workflows

```yaml
# Run on 10.5 Leopard
jobs:
  build-leopard:
    runs-on: [self-hosted, tenfive]
    steps:
      - run: uname -a

# Run on 10.7 Lion
jobs:
  build-lion:
    runs-on: [self-hosted, tenseven]
    steps:
      - run: uname -a

# Run on any legacy runner
jobs:
  build-legacy:
    runs-on: [self-hosted, ssh-legacy-capable]
    steps:
      - run: sudo port -v install myport
```

## Add New Legacy VM

1. Copy a runner service in `docker-compose.yml`
2. Update service name (e.g., `tensix-runner`)
3. Update `VM_HOSTNAME` (e.g., `tensix`)
4. Update `VM_HOSTNAME_FQDN` (e.g., `tensix-runner.local`)
5. Update labels to include version (e.g., `10-6`)
6. Add volume for work directory (e.g., `runner-work-tensix`)
7. Run setup script to generate token
8. Start: `docker compose up -d tensix-runner`

## Files Reference

- `.env` - Registration tokens (gitignored, generated by setup script)
- `docker-compose.yml` - Service definitions with hardcoded defaults
- `Dockerfile` - Auto-detecting architecture, installs runner and ssh client
- `entrypoint.sh` - Container startup, registers runner, monitors SSH
- `ssh_keys/oldmac` - Private SSH key (gitignored, you provide this)
- `setup-runners.sh` - Generate tokens and create `.env`

## Documentation

- `DOCKER_SETUP_GUIDE.md` - Comprehensive setup guide
- `REFACTORING_NOTES.md` - Details on the refactoring
- `BUILD_COMPLETE.md` - Summary of what was accomplished
- `README.md` - Architecture and design decisions
