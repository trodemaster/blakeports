# Docker Runners with Lima - Path Resolution Fixed

## What Was Wrong

The error was: `error mounting "/Users/blake/code/blakeports/docker/ssh_keys/oldmac" ... not a directory`

This happened because:
1. The path `/Users/blake/code/blakeports/` doesn't exist (repo is at `/Users/blake/Developer/blakeports/`)
2. Docker couldn't find the SSH key file
3. When a mount source doesn't exist, Docker treats it as wanting to mount a directory

## What We Fixed

✅ **Updated docker-compose.yml** to use absolute path:
```yaml
volumes:
  - /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac:/home/runner/.ssh/oldmac:ro
```

This path:
- Matches your actual repository location
- Works with Lima VM mounts (Lima preserves `/Users/...` paths)
- Is explicit and unambiguous for Docker

## Path Layer Alignment

Now all three layers align:

| Layer | Path | Status |
|-------|------|--------|
| macOS Host | `/Users/blake/Developer/blakeports/` | ✅ Actual location |
| Lima VM Mount | `/Users/blake/Developer/blakeports/` | ✅ Same path (Lima auto-mounts) |
| Docker Container | `/Users/blake/Developer/blakeports/` | ✅ Sees Lima mount |

## Setup Checklist

Run these commands in order in your terminal:

```bash
# 1. Navigate to docker directory
cd /Users/blake/Developer/blakeports/docker

# 2. Create SSH key (if not already done)
# Get OLDMAC_KEY from GitHub and save it:
echo "$OLDMAC_KEY" > ssh_keys/oldmac
chmod 600 ssh_keys/oldmac

# 3. Generate registration tokens
bash setup-runners.sh

# 4. Verify everything is set up correctly
bash verify-and-start.sh

# 5. If verify passes, build and start
docker compose build
docker compose up -d

# 6. Check status
docker compose ps
docker compose logs -f
```

## Key Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Service definitions with absolute SSH key path |
| `setup-runners.sh` | Generate tokens and create `.env` |
| `verify-and-start.sh` | Pre-flight checks before starting |
| `ssh_keys/oldmac` | SSH private key (must exist, gitignored) |
| `.env` | Registration tokens (gitignored, generated by setup script) |

## Critical: SSH Key File Must Exist

The absolute path in docker-compose.yml means:
- ✅ The file `/Users/blake/Developer/blakeports/docker/ssh_keys/oldmac` **must exist**
- ✅ It must be readable (`chmod 600`)
- ✅ It must be a file, not a directory

To verify:
```bash
ls -la /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac
# Should show: -rw------- (600 permissions)
```

## Next Steps

1. **Ensure SSH key exists** in the correct location
2. **Run verify script**:
   ```bash
   bash /Users/blake/Developer/blakeports/docker/verify-and-start.sh
   ```

3. **If all green**, start containers:
   ```bash
   docker compose up -d
   ```

4. **Check GitHub** for runner registration:
   ```bash
   gh api repos/trodemaster/blakeports/actions/runners
   ```

## Troubleshooting

### Still getting "not a directory" error
```bash
# Verify file exists and is readable
test -r /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac && echo "✅" || echo "❌"

# If file doesn't exist:
echo "$OLDMAC_KEY" > /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac
chmod 600 /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac
```

### Lima can't see the file
```bash
# Test from Lima
lima test -r /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac && echo "✅" || echo "❌"

# If this fails, the file doesn't exist on macOS yet
```

### Docker can't connect to Lima
```bash
# Check Lima is running
limactl list

# If not running:
limactl start default
```

## Reference Documents

- `PATH_AND_LIMA_GUIDE.md` - Detailed Lima path explanation
- `QUICK_REFERENCE.md` - Common docker compose commands
- `BUILD_COMPLETE.md` - Summary of the build setup
- `REFACTORING_NOTES.md` - Configuration minimization details
