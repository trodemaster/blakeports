# GitHub Actions Self-Hosted Runners for Legacy macOS VMs
# Each service represents one GitHub Actions runner instance targeting a specific legacy VM
# Each container must have a unique RUNNER_TOKEN generated via:
#   gh api repos/trodemaster/blakeports/actions/runners/registration-token --method POST --jq '.token'

services:
  # ============================================================================
  # Mac OS X 10.5 (Leopard) Runner
  # ============================================================================
  tenfive-runner:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUNNER_VERSION: 2.321.0
    container_name: tenfive-runner
    hostname: tenfive-runner
    restart: unless-stopped
    env_file: .env

    environment:
      # GitHub repository configuration
      - GITHUB_OWNER=trodemaster
      - GITHUB_REPO=blakeports
      
      # Runner-specific registration token (required: generate via setup-runners.sh)
      - RUNNER_TOKEN=${RUNNER_TOKEN_TENFIVE}
      
      # Runner name and SSH proxy configuration
      - RUNNER_NAME=tenfive-runner
      - RUNNER_WORKDIR=_work
      - CUSTOM_LABELS=ssh-legacy-capable,legacy-macos,tenfive,10-5
      
      # SSH proxy configuration for legacy VM
      - VM_HOSTNAME=tenfive
      - VM_HOSTNAME_FQDN=tenfive-runner.local
      - VM_IP=${TENFIVE_VM_IP}
      - VM_USER=admin
      - SSH_KEY_NAME=oldmac

    volumes:
      # SSH key for legacy VM authentication (read-only)
      # Absolute path works reliably with Lima VM mounts
      # The SSH key file MUST exist at this location
      - /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac:/home/runner/.ssh/oldmac:ro
      # Persistent work directory for runner state
      - runner-work-tenfive:/home/runner/_work

    network_mode: bridge


  # ============================================================================
  # Mac OS X 10.7 (Lion) Runner
  # ============================================================================
  tenseven-runner:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUNNER_VERSION: 2.321.0
    container_name: tenseven-runner
    hostname: tenseven-runner
    restart: unless-stopped
    env_file: .env

    environment:
      # GitHub repository configuration
      - GITHUB_OWNER=trodemaster
      - GITHUB_REPO=blakeports
      
      # Runner-specific registration token (required: generate via setup-runners.sh)
      - RUNNER_TOKEN=${RUNNER_TOKEN_TENSEVEN}
      
      # Runner name and SSH proxy configuration
      - RUNNER_NAME=tenseven-runner
      - RUNNER_WORKDIR=_work
      - CUSTOM_LABELS=ssh-legacy-capable,legacy-macos,tenseven,10-7
      
      # SSH proxy configuration for legacy VM
      - VM_HOSTNAME=tenseven
      - VM_HOSTNAME_FQDN=tenseven-runner.local
      - VM_IP=${TENSEVEN_VM_IP}
      - VM_USER=admin
      - SSH_KEY_NAME=oldmac

    volumes:
      # SSH key for legacy VM authentication (read-only)
      # Absolute path works reliably with Lima VM mounts
      # The SSH key file MUST exist at this location
      - /Users/blake/Developer/blakeports/docker/ssh_keys/oldmac:/home/runner/.ssh/oldmac:ro
      # Persistent work directory for runner state
      - runner-work-tenseven:/home/runner/_work

    network_mode: bridge


volumes:
  runner-work-tenfive:
    driver: local
  runner-work-tenseven:
    driver: local
