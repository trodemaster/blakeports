name: Build bstring

on:
  push:
    paths: ['textproc/bstring/**']
    branches: [main]
  pull_request:
    paths: ['textproc/bstring/**']
    branches: [main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: false
        default: 'main'
        type: string
      run_macos15:
        description: 'macOS 15 (Sequoia)'
        required: false
        default: true
        type: boolean
      run_macos26:
        description: 'macOS 26 (Tahoe)'
        required: false
        default: true
        type: boolean
      run_tenfive:
        description: 'Mac OS X 10.5 (Leopard)'
        required: false
        default: false
        type: boolean
      run_tensix:
        description: 'Mac OS X 10.6 (Snow Leopard)'
        required: false
        default: false
        type: boolean
      run_tenseven:
        description: 'Mac OS X 10.7 (Lion)'
        required: false
        default: false
        type: boolean
      run_teneight:
        description: 'Mac OS X 10.8 (Mountain Lion)'
        required: false
        default: false
        type: boolean
      run_tennine:
        description: 'Mac OS X 10.9 (Mavericks)'
        required: false
        default: false
        type: boolean
      run_tenten:
        description: 'Mac OS X 10.10 (Yosemite)'
        required: false
        default: false
        type: boolean

defaults:
  run:
    shell: bash

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate build matrix
        id: set-matrix
        run: |
          MATRIX='{"include":['
          FIRST=true

          # For non-workflow_dispatch events (push/PR), default to modern platforms
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            MATRIX+='{"platform":"macOS_15","runner":"macOS_15","type":"modern","port":"textproc/bstring"},'
            MATRIX+='{"platform":"macOS_26","runner":"macOS_26","type":"modern","port":"textproc/bstring"}'
            FIRST=false
          else
            # For workflow_dispatch, check individual platform selections

            # macOS 15
            if [[ "${{ inputs.run_macos15 }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"macOS_15","runner":"macOS_15","type":"modern","port":"textproc/bstring"}'
              FIRST=false
            fi

            # macOS 26
            if [[ "${{ inputs.run_macos26 }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"macOS_26","runner":"macOS_26","type":"modern","port":"textproc/bstring"}'
              FIRST=false
            fi

            # Mac OS X 10.5
            if [[ "${{ inputs.run_tenfive }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"tenfive","runner":["self-hosted","tenfive"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENFIVE_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenFive","os_version":"10.5","timeout":"60"}'
              FIRST=false
            fi

            # Mac OS X 10.6
            if [[ "${{ inputs.run_tensix }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"tensix","runner":["self-hosted","tensix"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENSIX_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenSix","os_version":"10.6","timeout":"60"}'
              FIRST=false
            fi

            # Mac OS X 10.7
            if [[ "${{ inputs.run_tenseven }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"tenseven","runner":["self-hosted","tenseven"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENSEVEN_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenSeven","os_version":"10.7","timeout":"60"}'
              FIRST=false
            fi

            # Mac OS X 10.8
            if [[ "${{ inputs.run_teneight }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"teneight","runner":["self-hosted","teneight"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENEIGHT_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenEight","os_version":"10.8","timeout":"60"}'
              FIRST=false
            fi

            # Mac OS X 10.9
            if [[ "${{ inputs.run_tennine }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"tennine","runner":["self-hosted","tennine"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENNINE_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenNine","os_version":"10.9","timeout":"60"}'
              FIRST=false
            fi

            # Mac OS X 10.10
            if [[ "${{ inputs.run_tenten }}" == "true" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"platform":"tenten","runner":["self-hosted","tenten"],"type":"legacy","port":"textproc/bstring","vm_ip":"${{ vars.LEGACY_TENTEN_IP }}","vm_username":"${{ vars.LEGACY_USERNAME }}","vm_name":"TenTen","os_version":"10.10","timeout":"60"}'
              FIRST=false
            fi

            # If no platforms selected, default to modern platforms
            if [[ "$FIRST" == "true" ]]; then
              MATRIX+='{"platform":"macOS_15","runner":"macOS_15","type":"modern","port":"textproc/bstring"},'
              MATRIX+='{"platform":"macOS_26","runner":"macOS_26","type":"modern","port":"textproc/bstring"}'
            fi
          fi

          MATRIX+=']}'

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix for trigger: ${{ github.event_name }}"
          echo "$MATRIX" | jq '.'

  build-bstring:
    needs: setup-matrix
    name: build-bstring (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}
      fail-fast: false

    steps:
      #
      # MODERN PLATFORM STEPS
      #
      - name: Show macOS version
        if: matrix.type == 'modern'
        run: |
          echo "Running on: ${{ matrix.platform }}"
          echo "Building port: bstring"
          echo "Building from branch: ${{ inputs.branch || github.ref_name }}"
          sw_vers

      - name: Checkout repository
        if: matrix.type == 'modern'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Setup MacPorts and BlakePorts Environment
        if: matrix.type == 'modern'
        run: ./scripts/installmacports

      - name: Lint portfile
        if: matrix.type == 'modern'
        run: |
          source ./setupenv.bash
          port lint --nitpick ${{ matrix.port }}

      - name: Clean existing installation
        if: matrix.type == 'modern'
        run: |
          source ./setupenv.bash
          if port installed bstring 2>/dev/null | grep -q bstring; then
            echo "Removing existing bstring installation..."
            # Uninstall all installed versions (including variants)
            port installed bstring | grep -E "^  bstring @" | awk '{print $1 " " $2}' | while read -r version_spec; do
              echo "Uninstalling $version_spec..."
              sudo port -f uninstall "$version_spec" || true
            done
            sudo port clean --dist bstring || true
            echo "✅ Clean complete"
          else
            echo "No existing bstring installation found"
          fi

      - name: Install dependencies
        if: matrix.type == 'modern'
        run: ./scripts/install-deps bstring

      - name: Build port
        if: matrix.type == 'modern'
        run: |
          source ./setupenv.bash
          sudo port -v install bstring

      - name: Verify installation
        if: matrix.type == 'modern'
        run: |
          source ./setupenv.bash
          port installed bstring

      - name: Test bstring with tests variant
        if: matrix.type == 'modern'
        run: |
          source ./setupenv.bash
          sudo port -v install bstring +tests

      #
      # LEGACY PLATFORM STEPS
      #
      - name: Checkout repository (for tarball)
        if: matrix.type == 'legacy'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Verify VM configuration
        if: matrix.type == 'legacy'
        run: |
          # Read VM configuration from mounted config file
          CONFIG_FILE="/config/runners.json"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Error: Config file not found at $CONFIG_FILE"
            ls -la /config/ 2>/dev/null || echo "  /config directory not accessible"
            exit 1
          fi
          
          VM_IP=$(jq -r ".runners[\"${{ matrix.platform }}\"].vm_ip // empty" "$CONFIG_FILE")
          VM_USERNAME=$(jq -r ".runners[\"${{ matrix.platform }}\"].vm_user // empty" "$CONFIG_FILE")
          SSH_KEY_NAME=$(jq -r ".runners[\"${{ matrix.platform }}\"].ssh_key // \"oldmac\"" "$CONFIG_FILE")
          SSH_KEY_PATH="/config/ssh_keys/${SSH_KEY_NAME}"
          
          if [ -z "$VM_IP" ]; then
            echo "Error: VM IP not set for ${{ matrix.platform }} in config"
            exit 1
          fi
          if [ -z "$VM_USERNAME" ]; then
            echo "Error: VM username not set for ${{ matrix.platform }} in config"
            exit 1
          fi
          if [ ! -f "$SSH_KEY_PATH" ]; then
            echo "Error: SSH key not found at $SSH_KEY_PATH"
            exit 1
          fi
          
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV
          echo "VM_USERNAME=$VM_USERNAME" >> $GITHUB_ENV
          echo "SSH_KEY_PATH=$SSH_KEY_PATH" >> $GITHUB_ENV
          
          echo "✅ Configuration verified. Will connect to: $VM_USERNAME@$VM_IP"

      - name: Show macOS version (legacy VM)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            echo "=================================================="
            echo "  Building bstring on Mac OS X ${{ matrix.os_version }} (${{ matrix.vm_name }})"
            echo "=================================================="
            sw_vers
            echo ""
            uname -a

      - name: Download repository tarball
        if: matrix.type == 'legacy'
        run: |
          echo "Downloading blakeports repository..."
          BRANCH="${{ inputs.branch || 'main' }}"
          curl -L -o /tmp/blakeports.tar.gz "https://github.com/trodemaster/blakeports/archive/refs/heads/${BRANCH}.tar.gz"
          echo "✅ Tarball downloaded: $(ls -lh /tmp/blakeports.tar.gz)"

      - name: Transfer tarball to legacy VM
        if: matrix.type == 'legacy'
        run: |
          echo "Transferring tarball to ${{ matrix.vm_name }} VM..."
          scp -i ${{ env.SSH_KEY_PATH }} \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o HostKeyAlgorithms=+ssh-rsa \
              -o PubkeyAcceptedKeyTypes=+ssh-rsa \
              /tmp/blakeports.tar.gz \
              ${{ env.VM_USERNAME }}@${{ env.VM_IP }}:/tmp/
          echo "✅ Tarball transferred"

      - name: Extract repository on legacy VM
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            echo "Setting up blakeports directory..."
            mkdir -p /Users/blake/code
            if [ -d /Users/blake/code/blakeports ]; then
              echo "Cleaning existing directory..."
              rm -rf /Users/blake/code/blakeports/*
              rm -rf /Users/blake/code/blakeports/.[!.]*
            else
              mkdir -p /Users/blake/code/blakeports
            fi
            cd /Users/blake/code/blakeports
            echo "Extracting tarball..."
            tar xzf /tmp/blakeports.tar.gz --strip-components=1
            rm /tmp/blakeports.tar.gz
            echo "✅ Repository ready"

      - name: Verify MacPorts and setup environment
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            set -x
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            if ! command -v port &> /dev/null; then
              echo "❌ ERROR: MacPorts not found"
              exit 1
            fi
            port version
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            portindex
            echo "✅ MacPorts verified"

      - name: Lint portfile (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            set -x
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            
            # Try lint first, if "Unknown dependency" error occurs, run portindex and retry once
            LINT_OUTPUT=$(port lint --nitpick ${{ matrix.port }} 2>&1) || true
            echo "$LINT_OUTPUT"
            
            if echo "$LINT_OUTPUT" | grep -q "Unknown dependency"; then
              echo "⚠️  Unknown dependency error - running portindex and retrying..."
              portindex
              LINT_OUTPUT=$(port lint --nitpick ${{ matrix.port }} 2>&1)
              echo "$LINT_OUTPUT"
            fi
            
            if echo "$LINT_OUTPUT" | grep -q "Error:"; then
              echo "❌ Lint failed"
              exit 1
            fi
            echo "✅ Lint passed"

      - name: Clean existing installation (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            if port installed bstring 2>/dev/null | grep -q bstring; then
              echo "Removing existing bstring installation..."
              port installed bstring | grep -E "^  bstring @" | awk '{print $1 " " $2}' | while read -r version_spec; do
                echo "Uninstalling $version_spec..."
                sudo port -f uninstall "$version_spec" || true
              done
              sudo port clean --dist bstring || true
            fi
            echo "✅ Clean complete"

      - name: Install dependencies (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: ${{ matrix.timeout }}m
          script: |
            set -e
            set -o pipefail
            set -x
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            ./scripts/install-deps bstring
            echo "✅ Dependencies installed"

      - name: Build port (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: ${{ matrix.timeout }}m
          script: |
            set -e
            set -o pipefail
            set -x
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            sudo port -v install bstring
            echo "✅ Build complete"

      - name: Verify installation (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            set -e
            set -o pipefail
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            port installed bstring
            echo "✅ Installation verified"

      - name: Test bstring with tests variant (legacy)
        if: matrix.type == 'legacy'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: ${{ matrix.timeout }}m
          script: |
            set -e
            set -o pipefail
            set -x
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            cd /Users/blake/code/blakeports
            source ./setupenv.bash
            sudo port -v install bstring +tests
            echo "✅ Variant test complete"

      - name: Cleanup (legacy)
        if: matrix.type == 'legacy' && always()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VM_IP }}
          username: ${{ env.VM_USERNAME }}
          key_path: ${{ env.SSH_KEY_PATH }}
          script: |
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            rm -f /tmp/blakeports.tar.gz
            echo "✅ Cleanup complete"
