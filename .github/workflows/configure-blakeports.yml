name: Configure BlakePorts

on:
  workflow_run:
    workflows: ["Install MacPorts"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  configure-blakeports:
    runs-on: [self-hosted, macOS, ARM64, tart]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: code/blakeports
        
    - name: Set up home directory structure
      run: |
        mkdir -p ~/code
        # Remove existing blakeports if it exists to avoid conflicts
        rm -rf ~/code/blakeports
        # Move checked out code to the expected location
        mv ${{ github.workspace }}/code/blakeports ~/code/blakeports
        
    - name: Make configure script executable
      run: chmod +x ~/code/blakeports/scripts/configblakeports
      
    - name: Run BlakePorts configuration script
      run: ~/code/blakeports/scripts/configblakeports
      
    - name: Verify BlakePorts configuration
      run: |
        echo "Checking MacPorts sources configuration..."
        cat /opt/local/etc/macports/sources.conf | grep -A1 -B1 blakeports || echo "BlakePorts not found in sources.conf"
        
    - name: Test port command with BlakePorts
      run: |
        echo "Testing port command..."
        /opt/local/bin/port sync || echo "Port sync failed"
        /opt/local/bin/port list | head -5 || echo "Port list failed" 