# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           meson 1.0
PortGroup           legacysupport 1.1

name                netatalk
version             4.4.0
revision            0
categories          net
description         Netatalk is a freely-available Open Source AFP fileserver.
long_description    Netatalk is a freely-available Open Source AFP fileserver. \
                    It allows Unix-like operating systems to serve as file \
                    servers for Macintosh computers.

if {${subport} eq ${name}} {
    github.setup        Netatalk netatalk fe225c6bafaee8c4aa5f9065efc4eb5e346ced3d
    version             4.4.0
    github.tarball_from archive
    # Using latest main branch commit after PR merge
    # GitHub archive API returns .tar.gz files, not .tar.xz
    # distname will be netatalk-{commit_sha} from github.setup
    # extract.rename will handle renaming the extracted directory

    compiler.c_standard 2011

    checksums       rmd160  311bb62bd9975fdcd81ac9ec0ac2f7cc89ba57dd \
                    sha256  ea5e9ede8f7a70a1d834e10d5a907f658bf10232b6080556fba15578a16a9218 \
                    size    1572835
    
    license             GPL-2+
    maintainers         {@trodemaster icloud.com:manuals-unread2u} openmaintainer
    
    homepage            https://netatalk.io
    
    depends_build-append       path:bin/pkg-config:pkgconfig \
                               port:cmark-gfm \
                               port:bison \
                               port:flex
    
    depends_lib         port:sqlite3 \
                        port:libevent \
                        port:libgcrypt \
                        port:iniparser \
                        port:tracker3 \
                        port:dbus \
                        port:talloc \
                        port:glib2 \
                        port:bstring
    
    configure.args-append -Dwith-init-style=none \
                          -Dwith-pam-config-path=${prefix}/etc/pam.d \
                          -Dwith-lockfile-path=${prefix}/var/run \
                          -Dwith-cnid-backends=sqlite \
                          -Dwith-cnid-default-backend=sqlite \
                          -Dwith-spotlight=true
    
    startupitem.create  yes
    startupitem.executable  ${prefix}/sbin/netatalk -d -F ${prefix}/etc/afp.conf
    startupitem.logfile ${prefix}/var/log/${name}.log
    startupitem.logfile.stderr ${prefix}/var/log/${name}-stderr.log
    startupitem.logevents yes
    startupitem.debug          yes
    
    notes "Upgrade details: https://netatalk.io/manual/en/Upgrading. Configuration files can be found in: ${prefix}/etc/. Log files can be found in: ${prefix}/var/log/."
    
    # Disable legacy support for newer macOS versions that don't need it
    legacysupport.newest_darwin_requires_legacy 20
    
    # SSL workaround for older macOS versions with GitHub download issues
    platform darwin {
        if {${os.major} <= 12} {
            depends_build-append port:curl
            
            fetch {
                # GitHub archive API returns .tar.gz files
                system "curl -L -o ${distpath}/${distname}.tar.gz '${github.master_sites}.tar.gz'"
            }
        }
    }
}

# Netatalk 4.x stub port
subport netatalk4 {
    PortGroup           stub 1.0

    version             4.4.0
    revision            0
    
    categories          net
    license             GPL-2+
    maintainers         {@trodemaster icloud.com:manuals-unread2u} openmaintainer
    
    description         Netatalk is a freely-available Open Source AFP fileserver.
    long_description    Netatalk is a freely-available Open Source AFP fileserver. \
                        It allows Unix-like operating systems to serve as file \
                        servers for Macintosh computers.
    
    homepage            https://netatalk.io
    
    # This is a stub port that depends on the main netatalk port
    depends_run         port:netatalk
    
    notes "This is a stub port that provides netatalk4 as an alias for netatalk. \
           The main netatalk port will automatically select the appropriate version \
           based on your macOS version."
}

