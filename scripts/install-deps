#!/bin/bash
# Script to install dependencies for a given port

set -euo pipefail

# Show usage
show_usage() {
    echo "Usage: $0 [OPTIONS] <portname>"
    echo ""
    echo "OPTIONS:"
    echo "  --runtime-only    Install only runtime dependencies (excludes build deps)"
    echo "  --help           Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 nrsc5                    # Install all dependencies"
    echo "  $0 --runtime-only nrsc5     # Install only runtime dependencies"
}

# Parse arguments
RUNTIME_ONLY=false
PORTNAME=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --runtime-only)
            RUNTIME_ONLY=true
            shift
            ;;
        --help)
            show_usage
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            show_usage
            exit 1
            ;;
        *)
            if [ -z "$PORTNAME" ]; then
                PORTNAME="$1"
            else
                echo "Error: Multiple port names specified"
                show_usage
                exit 1
            fi
            shift
            ;;
    esac
done

if [ -z "$PORTNAME" ]; then
    echo "Error: No port name specified"
    show_usage
    exit 1
fi

# Set MANPATH to avoid unbound variable error
export MANPATH="${MANPATH:-}"

# Source MacPorts environment from our local copy
# Try dynamic path detection first (for legacy VMs and flexible setups)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if [ -f "$REPO_ROOT/setupenv.bash" ]; then
    # Use dynamic path (works in any location)
    source "$REPO_ROOT/setupenv.bash"
elif [ -f "/opt/actions-runner/_work/blakeports/blakeports/setupenv.bash" ]; then
    # Fall back to hardcoded path (for existing GitHub Actions runners)
    source /opt/actions-runner/_work/blakeports/blakeports/setupenv.bash
else
    echo "Error: Cannot find setupenv.bash"
    exit 1
fi

echo "Getting dependencies for $PORTNAME..."

# Function to sync port index and retry
sync_and_retry_deps() {
    local portname=$1
    local runtime_only=$2
    
    echo "Port not found, syncing port index..."
    sudo port sync
    
    echo "Retrying to get dependencies for $portname..."
    if [ "$runtime_only" = true ]; then
        port deps --no-build "$portname" 2>&1
    else
        port deps "$portname" 2>&1
    fi
}

# Choose which dependencies to get
DEPS_OUTPUT=""
if [ "$RUNTIME_ONLY" = true ]; then
    echo "Mode: Runtime dependencies only"
    DEPS_OUTPUT=$(port deps --no-build "$PORTNAME" 2>&1) || {
        DEPS_EXIT_CODE=$?
        # Check if error is "port not found"
        if echo "$DEPS_OUTPUT" | grep -qi "not found\|port.*not found\|unknown port"; then
            DEPS_OUTPUT=$(sync_and_retry_deps "$PORTNAME" true)
        else
            echo "Error getting dependencies: $DEPS_OUTPUT" >&2
            exit $DEPS_EXIT_CODE
        fi
    }
else
    echo "Mode: All dependencies (build + runtime)"
    DEPS_OUTPUT=$(port deps "$PORTNAME" 2>&1) || {
        DEPS_EXIT_CODE=$?
        # Check if error is "port not found"
        if echo "$DEPS_OUTPUT" | grep -qi "not found\|port.*not found\|unknown port"; then
            DEPS_OUTPUT=$(sync_and_retry_deps "$PORTNAME" false)
        else
            echo "Error getting dependencies: $DEPS_OUTPUT" >&2
            exit $DEPS_EXIT_CODE
        fi
    }
fi

# Extract all dependencies (build + library)
DEPS=$(echo "$DEPS_OUTPUT" | sed -n 's/.*Dependencies: *//p' | tr ',' ' ' | tr -s ' ')

if [ -z "$DEPS" ]; then
    echo "No dependencies found for $PORTNAME"
    exit 0
fi

echo "Dependencies to install: $DEPS"
echo ""

# Install each dependency quietly
echo "Installing dependencies..."
for dep in $DEPS; do
    echo "  Installing $dep..."
    
    # Capture output and error status
    OUTPUT=$(sudo port install "$dep" 2>&1)
    INSTALL_EXIT_CODE=$?
    
    if [ $INSTALL_EXIT_CODE -eq 0 ]; then
        echo "  âœ… $dep installed"
    else
        # Check if error is "port not found" - if so, sync and retry once
        if echo "$OUTPUT" | grep -qi "not found\|port.*not found\|unknown port"; then
            echo "  âš ï¸  Port $dep not found, syncing port index and retrying..."
            sudo port sync
            echo "  Retrying installation of $dep..."
            if OUTPUT=$(sudo port install "$dep" 2>&1); then
                echo "  âœ… $dep installed (after sync)"
            else
                EXIT_CODE=$?
                echo "  âŒ Failed to install $dep after sync (exit code: $EXIT_CODE)"
                echo "  ğŸ“‹ Error details:"
                echo "$OUTPUT" | sed 's/^/     /'  # Indent error output
                echo ""
                
                # Try to find and display MacPorts log file
                LOG_FILE=$(echo "$OUTPUT" | grep -o '/opt/local/var/macports/logs/[^[:space:]]*main.log' | head -1)
                if [ -n "$LOG_FILE" ] && [ -f "$LOG_FILE" ]; then
                    echo "  ğŸ“„ MacPorts log file (last 200 lines):"
                    echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    tail -200 "$LOG_FILE" | sed 's/^/     /'
                    echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                fi
                
                exit $EXIT_CODE
            fi
        else
            echo "  âŒ Failed to install $dep (exit code: $INSTALL_EXIT_CODE)"
            echo "  ğŸ“‹ Error details:"
            echo "$OUTPUT" | sed 's/^/     /'  # Indent error output
            echo ""
            
            # Try to find and display MacPorts log file
            LOG_FILE=$(echo "$OUTPUT" | grep -o '/opt/local/var/macports/logs/[^[:space:]]*main.log' | head -1)
            if [ -n "$LOG_FILE" ] && [ -f "$LOG_FILE" ]; then
                echo "  ğŸ“„ MacPorts log file (last 200 lines):"
                echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                tail -200 "$LOG_FILE" | sed 's/^/     /'
                echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            fi
            
            exit $INSTALL_EXIT_CODE
        fi
    fi
done

echo ""
echo "ğŸ‰ All dependencies for $PORTNAME have been installed!"
echo "Installed: $DEPS" 