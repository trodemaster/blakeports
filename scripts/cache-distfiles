#!/bin/bash
# Script to pre-cache distfiles for curl bootstrap using local MacPorts
# This runs on the HOST system (not in containers) and uses local MacPorts
# to download all required distfiles, then copies them to the docker config
# cache directory which is mounted into GitHub Actions containers.
#
# Usage: ./scripts/cache-distfiles
#
# The cached files will be available in containers at:
# /config/distfiles-cache/<portname>/<distfile>

set -euo pipefail
IFS=$'\n\t'

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() {
    echo -e "${GREEN}ℹ️  $*${NC}"
}

warn() {
    echo -e "${YELLOW}⚠️  $*${NC}"
}

error() {
    echo -e "${RED}❌ $*${NC}"
}

header() {
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo -e "${BLUE}$*${NC}"
    echo -e "${BLUE}════════════════════════════════════════${NC}"
}

# Verify MacPorts is available
if ! command -v port &> /dev/null; then
    error "MacPorts not found. This script must run on the host with MacPorts installed."
    exit 1
fi

info "MacPorts found: $(which port)"
info "MacPorts version: $(port version)"

# Determine cache directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLAKEPORTS_ROOT="$(dirname "$SCRIPT_DIR")"
DOCKER_CONFIG_DIR="$BLAKEPORTS_ROOT/../jibb-runners/docker/config"
CACHE_DIR="$DOCKER_CONFIG_DIR/distfiles-cache"

if [ ! -d "$DOCKER_CONFIG_DIR" ]; then
    error "Docker config directory not found: $DOCKER_CONFIG_DIR"
    error "Expected jibb-runners to be at: $(dirname "$BLAKEPORTS_ROOT")/jibb-runners"
    exit 1
fi

header "Caching distfiles for curl bootstrap"
info "Source: Local MacPorts (/opt/local/var/macports/distfiles)"
info "Destination: $CACHE_DIR"

# Query MacPorts for curl dependencies dynamically
info "Querying MacPorts for curl dependencies (with +ssl -brotli -http2 -idn -psl -zstd)..."
CURL_VARIANTS="-brotli -http2 -idn -psl -zstd +ssl"

# Get all dependencies (recursive)
info "Running: port deps curl $CURL_VARIANTS"
PORTS=()
while IFS= read -r line; do
    # Parse dependencies from lines like "Library Dependencies: zlib, openssl, curl-ca-bundle"
    if [[ $line =~ ^(Extract|Build|Library|Runtime|Test)[[:space:]]+Dependencies:[[:space:]]*(.+)$ ]]; then
        deps="${BASH_REMATCH[2]}"
        # Split comma-separated list
        IFS=',' read -ra DEP_ARRAY <<< "$deps"
        for dep in "${DEP_ARRAY[@]}"; do
            # Trim whitespace
            dep=$(echo "$dep" | xargs)
            # Remove @version if present
            dep="${dep%@*}"
            if [ -n "$dep" ]; then
                PORTS+=("$dep")
                info "  Found dependency: $dep"
            fi
        done
    fi
done < <(port deps curl $CURL_VARIANTS 2>&1)

# Add curl itself
if [ ${#PORTS[@]} -eq 0 ]; then
    PORTS=("curl")
else
    PORTS=("curl" "${PORTS[@]}")
fi

# Remove duplicates while preserving order (bash 3.2 compatible)
declare -a UNIQUE_PORTS=()
for port in "${PORTS[@]}"; do
    # Check if port already in UNIQUE_PORTS array
    found=0
    if [ ${#UNIQUE_PORTS[@]} -gt 0 ]; then
        for existing in "${UNIQUE_PORTS[@]}"; do
            if [ "$existing" = "$port" ]; then
                found=1
                break
            fi
        done
    fi
    if [ $found -eq 0 ]; then
        UNIQUE_PORTS+=("$port")
    fi
done
PORTS=("${UNIQUE_PORTS[@]}")

info "Total unique ports to cache: ${#PORTS[@]}"
echo ""

# Create cache directory structure
info "Creating cache directory structure..."
for port in "${PORTS[@]}"; do
    mkdir -p "$CACHE_DIR/$port"
done

header "Phase 1: Fetching distfiles with MacPorts"

for port in "${PORTS[@]}"; do
    info "Fetching distfiles for: $port"
    if sudo port fetch "$port" 2>&1 | grep -v "^$"; then
        info "✅ Fetched $port"
    else
        warn "⚠️  Fetch may have failed for $port (or already cached)"
    fi
done

header "Phase 2: Copying distfiles to cache and creating manifest"

# Copy distfiles from MacPorts to cache
MACPORTS_DISTFILES="/opt/local/var/macports/distfiles"
copied_count=0
failed_count=0
MANIFEST_FILE="$CACHE_DIR/manifest.txt"

# Clear old manifest
> "$MANIFEST_FILE"

for port in "${PORTS[@]}"; do
    # Query actual distfiles for this port
    info "Querying distfiles for: $port"
    distfiles=()
    while IFS= read -r line; do
        # Extract filename from lines like: "[filename] /path/to/file"
        if [[ $line =~ ^\[([^\]]+)\] ]]; then
            distfile="${BASH_REMATCH[1]}"
            distfiles+=("$distfile")
            info "  Found distfile: $distfile"
        fi
    done < <(port distfiles "$port" 2>&1)
    
    if [ ${#distfiles[@]} -eq 0 ]; then
        info "  No distfiles for $port (meta-port or subport)"
        continue
    fi
    
    # Determine source directory (handle subports that share distfiles)
    src_dir="$MACPORTS_DISTFILES/$port"
    if [ ! -d "$src_dir" ]; then
        # Try parent port for subports (e.g., gettext-runtime -> gettext)
        parent_port="${port%-*}"
        if [ "$parent_port" != "$port" ] && [ -d "$MACPORTS_DISTFILES/$parent_port" ]; then
            src_dir="$MACPORTS_DISTFILES/$parent_port"
            info "  Using parent distfiles: $parent_port"
        else
            warn "  Source directory not found: $src_dir"
            ((failed_count++))
            continue
        fi
    fi
    
    # Copy distfiles
    for distfile in "${distfiles[@]}"; do
        src_file="$src_dir/$distfile"
        if [ -f "$src_file" ]; then
            cp "$src_file" "$CACHE_DIR/$port/" && info "  ✅ $distfile"
            ((copied_count++))
            # Add to manifest
            echo "$port:$distfile" >> "$MANIFEST_FILE"
        else
            warn "  Distfile not found: $src_file"
            ((failed_count++))
        fi
    done
done

header "Phase 3: Verification"

info "Cache directory contents:"
du -sh "$CACHE_DIR"/*/ 2>/dev/null | head -20 || echo "No subdirectories"
if [ $(find "$CACHE_DIR" -type d -mindepth 1 -maxdepth 1 | wc -l) -gt 20 ]; then
    echo "  ... and $(($(find "$CACHE_DIR" -type d -mindepth 1 -maxdepth 1 | wc -l) - 20)) more directories"
fi
echo ""
info "Total cached files: $(grep -c ':' "$MANIFEST_FILE" 2>/dev/null || echo 0)"
echo ""
info "Total cache size: $(du -sh "$CACHE_DIR" | cut -f1)"
echo ""
info "Manifest file: $MANIFEST_FILE"
info "  Contains $(wc -l < "$MANIFEST_FILE" | tr -d ' ') entries"

if [ $failed_count -gt 0 ]; then
    warn "Warning: $failed_count items had issues"
fi

header "✅ Distfile caching complete!"
info "Copied $copied_count files to cache"
info "Cache location: $CACHE_DIR"
info ""
info "The GitHub Actions containers will find these files at:"
info "  /config/distfiles-cache/<portname>/<distfile>"
info ""
info "Manifest created at:"
info "  /config/distfiles-cache/manifest.txt"
info ""
info "You can now run the update-macports-legacy workflow."

exit 0
