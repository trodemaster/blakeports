#!/bin/bash
# Script to pre-cache distfiles for curl bootstrap using local MacPorts
# This runs on the HOST system (not in containers) and uses local MacPorts
# to download all required distfiles, then copies them to the docker config
# cache directory which is mounted into GitHub Actions containers.
#
# Usage: ./scripts/cache-distfiles
#
# The cached files will be available in containers at:
# /config/distfiles-cache/<portname>/<distfile>

set -euo pipefail
IFS=$'\n\t'

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() {
    echo -e "${GREEN}ℹ️  $*${NC}"
}

warn() {
    echo -e "${YELLOW}⚠️  $*${NC}"
}

error() {
    echo -e "${RED}❌ $*${NC}"
}

header() {
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo -e "${BLUE}$*${NC}"
    echo -e "${BLUE}════════════════════════════════════════${NC}"
}

# Verify MacPorts is available
if ! command -v port &> /dev/null; then
    error "MacPorts not found. This script must run on the host with MacPorts installed."
    exit 1
fi

info "MacPorts found: $(which port)"
info "MacPorts version: $(port version)"

# Determine cache directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLAKEPORTS_ROOT="$(dirname "$SCRIPT_DIR")"
DOCKER_CONFIG_DIR="$BLAKEPORTS_ROOT/../jibb-runners/docker/config"
CACHE_DIR="$DOCKER_CONFIG_DIR/distfiles-cache"

if [ ! -d "$DOCKER_CONFIG_DIR" ]; then
    error "Docker config directory not found: $DOCKER_CONFIG_DIR"
    error "Expected jibb-runners to be at: $(dirname "$BLAKEPORTS_ROOT")/jibb-runners"
    exit 1
fi

header "Caching distfiles for curl bootstrap"
info "Source: Local MacPorts (/opt/local/var/macports/distfiles)"
info "Destination: $CACHE_DIR"

# Create cache directory structure
info "Creating cache directory structure..."
mkdir -p "$CACHE_DIR"/{curl,zlib,openssl3,pkgconfig,libiconv,gperf,perl5.34,db48,gdbm,gettext,ncurses,readline,xz,unzip}

# List of ports we need for curl +ssl -brotli -http2 -idn -psl -zstd
PORTS=(
    "curl"
    "zlib"
    "openssl3"
    "pkgconfig"
    "libiconv"
    "gperf"
    "perl5.34"
    "db48"
    "gdbm"
    "gettext"
    "gettext-runtime"
    "gettext-tools-libs"
    "libtextstyle"
    "ncurses"
    "readline"
    "xz"
    "unzip"
)

header "Phase 1: Fetching distfiles with MacPorts"

for port in "${PORTS[@]}"; do
    info "Fetching distfiles for: $port"
    if sudo port fetch "$port" 2>&1 | grep -v "^$"; then
        info "✅ Fetched $port"
    else
        warn "⚠️  Fetch may have failed for $port (or already cached)"
    fi
done

header "Phase 2: Copying distfiles to cache"

# Copy distfiles from MacPorts to cache
MACPORTS_DISTFILES="/opt/local/var/macports/distfiles"
copied_count=0
failed_count=0

for port in "${PORTS[@]}"; do
    # Handle ports that share the same distfile directory
    case "$port" in
        gettext-runtime|gettext-tools-libs|libtextstyle)
            src_dir="$MACPORTS_DISTFILES/gettext"
            ;;
        *)
            src_dir="$MACPORTS_DISTFILES/$port"
            ;;
    esac
    
    if [ ! -d "$src_dir" ]; then
        warn "Source directory not found: $src_dir"
        ((failed_count++))
        continue
    fi
    
    info "Copying $port distfiles..."
    
    # Copy all files from source to cache
    for file in "$src_dir"/*; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            # Determine cache subdirectory
            case "$port" in
                gettext-runtime|gettext-tools-libs|libtextstyle)
                    cache_subdir="$CACHE_DIR/gettext"
                    ;;
                *)
                    cache_subdir="$CACHE_DIR/$port"
                    ;;
            esac
            
            cp "$file" "$cache_subdir/" && info "  ✅ $filename"
            ((copied_count++))
        fi
    done
done

header "Phase 3: Verification"

info "Cache directory contents:"
du -sh "$CACHE_DIR"/*/ 2>/dev/null || echo "No subdirectories"
echo ""
info "Total cached files: $(find "$CACHE_DIR" -type f | wc -l | tr -d ' ')"
echo ""
info "Total cache size: $(du -sh "$CACHE_DIR" | cut -f1)"

if [ $failed_count -gt 0 ]; then
    warn "Warning: $failed_count ports had issues"
fi

header "✅ Distfile caching complete!"
info "Copied $copied_count files to cache"
info "Cache location: $CACHE_DIR"
info ""
info "The GitHub Actions containers will find these files at:"
info "  /config/distfiles-cache/<portname>/<distfile>"
info ""
info "You can now run the update-macports-legacy workflow."

exit 0
