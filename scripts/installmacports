#!/bin/bash
set -euo pipefail
IFS=$'\n\t'
shopt -s nullglob nocaseglob

# BlakePorts MacPorts Configuration Script
# This script configures MacPorts sources.conf for GitHub Actions runners
# to use the local blakeports checkout as the default port source.
#
# Prerequisites: MacPorts must already be installed (handled by packer VM image)

# track if we need to sync macports
NEED_SYNC=false

# Verify MacPorts is installed
if [ ! -f /opt/local/bin/port ]; then
  echo "Error: MacPorts is not installed. Please use a VM image with MacPorts pre-installed."
  exit 1
fi

echo "✓ MacPorts is installed"

# Configure macports sources.conf for GitHub Actions runner
# This adds the local blakeports checkout as the default source
if ! grep -q "blakeports" /opt/local/etc/macports/sources.conf; then
  echo "Configuring macports /opt/local/etc/macports/sources.conf"
  sudo tee /opt/local/etc/macports/sources.conf <<EOF
file:///opt/actions-runner/_work/blakeports/blakeports [default]
https://mirror.fcix.net/macports/release/tarballs/ports.tar
EOF
  NEED_SYNC=true
else
  echo "✓ MacPorts sources.conf already configured for blakeports"
fi

# set up macports environment for current session
export PATH="/opt/local/bin:/opt/local/sbin:$PATH"
export MANPATH="/opt/local/share/man:${MANPATH:-}"

# sync macports to update port index (only if needed)
# Note: -v flag is required due to MacPorts bug "can't read verboseflag: no such variable"
# Output suppressed as it produces tens of thousands of lines
if [[ "$NEED_SYNC" == "true" ]]; then
  echo "Syncing MacPorts port index..."
  sudo port -v sync >/dev/null 2>&1
else
  echo "✓ Skipping port sync - no changes detected"
fi

echo "✓ MacPorts setup complete!"

exit 0
