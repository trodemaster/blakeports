#!/bin/bash
# Script to pre-fetch distfiles for ports and transfer them to legacy VMs
# This solves the circular dependency: curl needs distfiles, but system curl 
# on legacy systems cannot download from modern HTTPS servers.
#
# Usage: prefetch-distfiles <vm_ip> <vm_username> <ssh_key_path> [port_list]
#
# Distfiles are downloaded in the container (which has modern curl) and then
# SCPed to the legacy VM's MacPorts distfiles directory, where port install
# will find them locally and skip the download phase.
#
# Default port list for curl +ssl bootstrap:
# curl zlib openssl3 curl-ca-bundle pkgconfig libiconv perl5.34 gperf
# db48 gdbm gettext gettext-runtime gettext-tools-libs readline 
# libtextstyle ncurses xz unzip
#
# Extract dependencies: xz, unzip (pre-built tools used during extraction)

set -euo pipefail
IFS=$'\n\t'

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
info() {
    echo -e "${GREEN}ℹ️  $*${NC}"
}

warn() {
    echo -e "${YELLOW}⚠️  $*${NC}"
}

error() {
    echo -e "${RED}❌ $*${NC}"
}

header() {
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo -e "${BLUE}$*${NC}"
    echo -e "${BLUE}════════════════════════════════════════${NC}"
}

# Hardcoded distfiles list for curl +ssl -brotli -http2 -idn -psl -zstd bootstrap
# Format: "port:distfile:url" - Using upstream/GitHub as primary (fast in GitHub Actions)
declare -a DISTFILES=(
    # curl and dependencies
    "curl:curl-8.13.0.tar.xz:https://curl.se/download/curl-8.13.0.tar.xz"
    "zlib:zlib-1.3.1.tar.xz:https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.xz"
    "openssl3:openssl-3.5.4.tar.gz:https://github.com/openssl/openssl/releases/download/openssl-3.5.4/openssl-3.5.4.tar.gz"
    "pkgconfig:pkg-config-0.29.2.tar.gz:https://pkg-config.freedesktop.org/releases/pkg-config-0.29.2.tar.gz"
    
    # curl-ca-bundle needs curl again (already have it)
    # curl-ca-bundle:certdata-20241119-fc857d1685f9cd017a2cf656a52d871b02a4cc89.zip:https://hg.mozilla.org/mozilla-central/archive/fc857d1685f9cd017a2cf656a52d871b02a4cc89.zip
    
    # libiconv and dependencies
    "libiconv:libiconv-1.17.tar.gz:https://ftp.gnu.org/gnu/libiconv/libiconv-1.17.tar.gz"
    "gperf:gperf-3.3.tar.gz:https://ftp.gnu.org/gnu/gperf/gperf-3.3.tar.gz"
    
    # Perl and dependencies
    "perl5.34:perl-5.34.3.tar.xz:https://www.cpan.org/src/5.0/perl-5.34.3.tar.xz"
    "db48:db-4.8.30.tar.gz:https://download.oracle.com/berkeley-db/db-4.8.30.tar.gz"
    "gdbm:gdbm-1.26.tar.gz:https://ftp.gnu.org/gnu/gdbm/gdbm-1.26.tar.gz"
    
    # gettext and dependencies
    "gettext:gettext-0.22.5.tar.gz:https://ftp.gnu.org/gnu/gettext/gettext-0.22.5.tar.gz"
    "ncurses:ncurses-6.5.tar.gz:https://ftp.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz"
    
    # readline
    "readline:readline-8.2.tar.gz:https://ftp.gnu.org/gnu/readline/readline-8.2.tar.gz"
    
    # Tools
    "xz:xz-5.8.1.tar.bz2:https://github.com/tukaani-project/xz/releases/download/v5.8.1/xz-5.8.1.tar.bz2"
    "unzip:unzip60.tar.gz:https://downloads.sourceforge.net/infozip/unzip60.tar.gz"
)

# Parse arguments
if [[ $# -lt 3 ]]; then
    error "Usage: $0 <vm_ip> <vm_username> <ssh_key_path> [port_list_file]"
    echo "Example: $0 192.168.234.110 blake /config/ssh_keys/oldmac"
    exit 1
fi

VM_IP="$1"
VM_USERNAME="$2"
SSH_KEY_PATH="$3"
MACPORTS_PREFIX="/opt/local"
DISTFILES_DIR="/opt/local/var/macports/distfiles"
TEMP_DIR="/tmp/prefetch-distfiles-$$"

# Cleanup on exit
cleanup() {
    if [ -d "$TEMP_DIR" ]; then
        info "Cleaning up temporary directory..."
        rm -rf "$TEMP_DIR"
    fi
}
trap cleanup EXIT

header "Prefetching distfiles for curl bootstrap"
info "VM: $VM_USERNAME@$VM_IP"
info "Temp directory: $TEMP_DIR"

# Create temporary directory
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

# Phase 1: Download all distfiles locally
header "Phase 1: Downloading distfiles in container"

total_files=${#DISTFILES[@]}
downloaded_count=0
failed_files=()

for entry in "${DISTFILES[@]}"; do
    port_name=$(echo "$entry" | cut -d: -f1)
    distfile=$(echo "$entry" | cut -d: -f2)
    # Extract URL (everything after second colon, handles https:// correctly)
    url=$(echo "$entry" | cut -d: -f3-)
    
    echo ""
    info "[$((++downloaded_count))/$total_files] Downloading $port_name: $distfile"
    
    # Create port-specific directory
    mkdir -p "$port_name"
    cd "$port_name"
    
    # Try to download - show errors but filter progress bars
    set +e
    curl -f -L -o "$distfile" "$url" 2>&1 | grep -v "^  %"
    curl_exit=$?
    set -e
    
    if [ $curl_exit -eq 0 ] && [ -f "$distfile" ] && [ -s "$distfile" ]; then
        info "✅ Downloaded: $distfile"
    else
        warn "Download failed from primary URL (exit code: $curl_exit), trying alternate sources..."
        
        # Fallback URLs (MacPorts mirrors and alternate sources)
        case "$port_name" in
            curl)
                urls=("https://curl.askapache.com/$distfile" "https://distfiles.macports.org/curl/$distfile")
                ;;
            zlib)
                urls=("https://www.zlib.net/$distfile" "https://distfiles.macports.org/zlib/$distfile")
                ;;
            openssl3)
                urls=("https://www.openssl.org/source/$distfile" "https://distfiles.macports.org/openssl3/$distfile")
                ;;
            pkgconfig)
                urls=("https://distfiles.macports.org/pkgconfig/$distfile")
                ;;
            libiconv)
                urls=("https://ftpmirror.gnu.org/libiconv/$distfile" "https://distfiles.macports.org/libiconv/$distfile")
                ;;
            gperf)
                urls=("https://ftpmirror.gnu.org/gperf/$distfile" "https://distfiles.macports.org/gperf/$distfile")
                ;;
            perl5.34)
                urls=("https://cpan.metacpan.org/authors/id/S/SH/SHAY/$distfile" "https://distfiles.macports.org/perl5.34/$distfile")
                ;;
            db48)
                urls=("https://distfiles.macports.org/db48/$distfile")
                ;;
            gdbm)
                urls=("https://ftpmirror.gnu.org/gdbm/$distfile" "https://distfiles.macports.org/gdbm/$distfile")
                ;;
            gettext)
                urls=("https://ftpmirror.gnu.org/gettext/$distfile" "https://distfiles.macports.org/gettext/$distfile")
                ;;
            ncurses)
                urls=("https://invisible-mirror.net/archives/ncurses/$distfile" "https://distfiles.macports.org/ncurses/$distfile")
                ;;
            readline)
                urls=("https://ftpmirror.gnu.org/readline/$distfile" "https://distfiles.macports.org/readline/$distfile")
                ;;
            xz)
                urls=("https://sourceforge.net/projects/lzmautils/files/$distfile" "https://distfiles.macports.org/xz/$distfile")
                ;;
            unzip)
                urls=("https://distfiles.macports.org/unzip/$distfile")
                ;;
            *)
                urls=()
                ;;
        esac
        
        downloaded=false
        for alt_url in "${urls[@]}"; do
            set +e
            curl -f -L -o "$distfile" "$alt_url" 2>&1 | grep -v "^  %"
            curl_exit=$?
            set -e
            if [ $curl_exit -eq 0 ] && [ -f "$distfile" ] && [ -s "$distfile" ]; then
                info "✅ Downloaded from alternate source: $distfile"
                downloaded=true
                break
            fi
        done
        
        if [ "$downloaded" = false ]; then
            error "Failed to download $distfile from any source"
            failed_files+=("$port_name:$distfile")
        fi
    fi
    
    cd "$TEMP_DIR"
done

# Check for failures
if [ ${#failed_files[@]} -gt 0 ]; then
    error "Failed to download ${#failed_files[@]} files:"
    for failed in "${failed_files[@]}"; do
        echo "  - $failed"
    done
    error "Cannot proceed without all distfiles"
    exit 1
fi

info "✅ All distfiles downloaded successfully"

# Phase 2: Transfer distfiles to legacy VM
header "Phase 2: Transferring distfiles to legacy VM"

info "Creating temporary transfer directory on VM..."
ssh -i "$SSH_KEY_PATH" \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o HostKeyAlgorithms=+ssh-rsa \
    -o PubkeyAcceptedKeyTypes=+ssh-rsa \
    "$VM_USERNAME@$VM_IP" bash <<'VMEOF'
set -e
# Create temp directory for transfers (no sudo needed)
mkdir -p /tmp/prefetch-distfiles
# Create distfiles structure with sudo
sudo mkdir -p /opt/local/var/macports/distfiles/{curl,zlib,openssl3,pkgconfig,libiconv,gperf,perl5.34,db48,gdbm,gettext,ncurses,readline,xz,unzip}
echo "✅ Directories created"
VMEOF

# Transfer each distfile via SCP to /tmp first
transferred_count=0
cd "$TEMP_DIR"

for entry in "${DISTFILES[@]}"; do
    port_name=$(echo "$entry" | cut -d: -f1)
    distfile=$(echo "$entry" | cut -d: -f2)
    
    if [ ! -f "$port_name/$distfile" ]; then
        warn "Skipping $port_name/$distfile (not found locally, may have failed to download)"
        continue
    fi
    
    info "[$((++transferred_count))/$total_files] Transferring $port_name/$distfile..."
    
    # SCP to /tmp first (no sudo needed)
    scp -i "$SSH_KEY_PATH" \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o HostKeyAlgorithms=+ssh-rsa \
        -o PubkeyAcceptedKeyTypes=+ssh-rsa \
        "$port_name/$distfile" \
        "$VM_USERNAME@$VM_IP:/tmp/prefetch-distfiles/" || {
        error "Failed to transfer $port_name/$distfile"
        exit 1
    }
    
    # Move to final location with sudo and set permissions
    ssh -i "$SSH_KEY_PATH" \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o HostKeyAlgorithms=+ssh-rsa \
        -o PubkeyAcceptedKeyTypes=+ssh-rsa \
        "$VM_USERNAME@$VM_IP" "sudo mv /tmp/prefetch-distfiles/$distfile $DISTFILES_DIR/$port_name/ && sudo chmod 644 $DISTFILES_DIR/$port_name/$distfile" || {
        error "Failed to move $port_name/$distfile to final location"
        exit 1
    }
done

info "✅ All distfiles transferred successfully"

# Phase 3: Verify transfer and cleanup
header "Phase 3: Verifying distfiles on VM"

info "Checking distfiles directory on VM..."
ssh -i "$SSH_KEY_PATH" \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o HostKeyAlgorithms=+ssh-rsa \
    -o PubkeyAcceptedKeyTypes=+ssh-rsa \
    "$VM_USERNAME@$VM_IP" bash <<'VMEOF'
set -e
echo "Distfiles directory contents:"
du -sh /opt/local/var/macports/distfiles/*/ 2>/dev/null || echo "No subdirectories yet"
echo ""
echo "Total distfiles size:"
du -sh /opt/local/var/macports/distfiles/
echo ""
echo "Total files:"
find /opt/local/var/macports/distfiles -type f | wc -l
echo ""
echo "Permissions check (should be readable by all):"
ls -la /opt/local/var/macports/distfiles/curl/ 2>/dev/null | head -5 || echo "curl directory not found"
echo ""
echo "Cleaning up temp directory..."
rm -rf /tmp/prefetch-distfiles
VMEOF

header "✅ Distfile prefetch complete!"
info "Distfiles are now available locally on the VM"
info "port install curl -brotli -http2 -idn -psl -zstd +ssl will use local files"

exit 0
